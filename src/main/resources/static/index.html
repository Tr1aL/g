<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Настройки бота</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .app {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1, h2 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }

        h2 {
            margin-top: 40px;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .settings-table, .bots-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .settings-table th,
        .settings-table td,
        .bots-table th,
        .bots-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .settings-table th,
        .bots-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #495057;
        }

        .key-column {
            font-weight: 600;
            color: #495057;
            width: 30%;
        }

        .bots-table th:nth-child(1),
        .bots-table td:nth-child(1) {
            width: 25%;
        }

        .bots-table th:nth-child(2),
        .bots-table td:nth-child(2) {
            width: 20%;
        }

        .bots-table th:nth-child(3),
        .bots-table td:nth-child(3) {
            width: 20%;
        }

        .bots-table th:nth-child(4),
        .bots-table td:nth-child(4) {
            width: 20%;
        }

        .input-field {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .input-field:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .save-button, .refresh-button {
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin: 10px 5px;
        }

        .save-button {
            background-color: #007bff;
        }

        .save-button:hover:not(:disabled) {
            background-color: #0056b3;
        }

        .refresh-button {
            background-color: #28a745;
        }

        .refresh-button:hover:not(:disabled) {
            background-color: #218838;
        }

        .save-button:disabled,
        .refresh-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        .button-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }

        .loading {
            text-align: center;
            font-size: 18px;
            color: #666;
            padding: 50px;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #c3e6cb;
        }

        .null-value {
            color: #999;
            font-style: italic;
        }

        .positive-change {
            color: #28a745;
            font-weight: bold;
        }

        .negative-change {
            color: #dc3545;
            font-weight: bold;
        }
    </style>
</head>
<body>
<div id="root"></div>

<!-- Подключаем React и Babel для JSX -->
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script type="text/babel">
    const {useState, useEffect} = React;

    function App() {
        const [settings, setSettings] = useState({
            botCount: 0,
            paperContext: false,
            botLeaveEnabled: false,
            botLeavePercent: 0.00,
            botTemplateName: ''
        });
        const [bots, setBots] = useState([]);
        const [loading, setLoading] = useState(true);
        const [loadingBots, setLoadingBots] = useState(false);
        const [error, setError] = useState(null);
        const [successMessage, setSuccessMessage] = useState('');

        // Загрузка настроек и ботов
        useEffect(() => {
            fetchSettings();
            fetchBots();
        }, []);

        const fetchSettings = async () => {
            try {
                setLoading(true);
                const response = await fetch('/settings');
                if (!response.ok) {
                    throw new Error('Ошибка загрузки настроек');
                }
                const data = await response.json();
                setSettings(data);
                setError(null);
            } catch (err) {
                setError(err.message);
            } finally {
                setLoading(false);
            }
        };

        const fetchBots = async () => {
            try {
                setLoadingBots(true);
                const response = await fetch('/bots/info');
                if (!response.ok) {
                    throw new Error('Ошибка загрузки списка ботов');
                }
                const data = await response.json();
                setBots(data);
                setError(null);
            } catch (err) {
                setError(err.message);
            } finally {
                setLoadingBots(false);
            }
        };

        // Обработка изменений в полях ввода
        const handleInputChange = (key, value) => {
            setSettings(prev => ({
                ...prev,
                [key]: (key === 'paperContext' || key === 'botLeaveEnabled') ? value === 'true' :
                    key === 'botCount' ? parseInt(value) || 0 :
                        key === 'botLeavePercent' ? parseFloat(value) || 0.00 : value
            }));
        };

        // Отправка измененных настроек
        const handleSubmit = async (e) => {
            e.preventDefault();
            try {
                setLoading(true);
                const response = await fetch('/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(settings)
                });

                if (!response.ok) {
                    throw new Error('Ошибка сохранения настроек');
                }

                setSuccessMessage('Настройки успешно сохранены!');
                setError(null);

                // Автоматически скрываем сообщение об успехе через 3 секунды
                setTimeout(() => setSuccessMessage(''), 3000);

            } catch (err) {
                setError(err.message);
                setSuccessMessage('');
            } finally {
                setLoading(false);
            }
        };

        // Форматирование числа
        const formatNumber = (num) => {
            if (num === null || num === undefined) return 'N/A';
            return num.toFixed(2);
        };

        // Расчет изменения в процентах
        const calculateChange = (start, current) => {
            if (start === null || current === null || start === 0) return null;
            return ((current - start) / start) * 100;
        };

        if (loading) {
            return React.createElement('div', {className: 'loading'}, 'Загрузка...');
        }

        return React.createElement('div', {className: 'app'},
            React.createElement('h1', null, 'Настройки бота'),

            error && React.createElement('div', {className: 'error'}, error),
            successMessage && React.createElement('div', {className: 'success'}, successMessage),

            React.createElement('form', {onSubmit: handleSubmit},
                React.createElement('table', {className: 'settings-table'},
                    React.createElement('thead', null,
                        React.createElement('tr', null,
                            React.createElement('th', null, 'Параметр'),
                            React.createElement('th', null, 'Значение')
                        )
                    ),
                    React.createElement('tbody', null,
                        Object.entries(settings).map(([key, value]) =>
                            React.createElement('tr', {key: key},
                                React.createElement('td', {className: 'key-column'}, key),
                                React.createElement('td', null,
                                    (key === 'paperContext' || key === 'botLeaveEnabled') ?
                                        React.createElement('select', {
                                                value: value.toString(),
                                                onChange: (e) => handleInputChange(key, e.target.value),
                                                className: 'input-field'
                                            },
                                            React.createElement('option', {value: 'true'}, 'true'),
                                            React.createElement('option', {value: 'false'}, 'false')
                                        )
                                        : React.createElement('input', {
                                            type: key === 'botLeavePercent' ? 'number' :
                                                key === 'botCount' ? 'number' : 'text',
                                            step: key === 'botLeavePercent' ? '0.01' : '1',
                                            value: value,
                                            onChange: (e) => handleInputChange(key, e.target.value),
                                            className: 'input-field'
                                        })
                                )
                            )
                        )
                    )
                ),

                React.createElement('div', {className: 'button-container'},
                    React.createElement('button', {
                        type: 'submit',
                        className: 'save-button',
                        disabled: loading
                    }, loading ? 'Сохранение...' : 'Сохранить настройки')
                )
            ),

            React.createElement('h2', null, 'Текущие боты'),

            loadingBots ?
                React.createElement('div', {className: 'loading'}, 'Загрузка списка ботов...') :
                React.createElement('table', {className: 'bots-table'},
                    React.createElement('thead', null,
                        React.createElement('tr', null,
                            React.createElement('th', null, 'ID бота'),
                            React.createElement('th', null, 'Символ'),
                            React.createElement('th', null, 'Начальный ADTS'),
                            React.createElement('th', null, 'Текущий ADTS'),
                        )
                    ),
                    React.createElement('tbody', null,
                        bots.length === 0 ?
                            React.createElement('tr', null,
                                React.createElement('td', {colSpan: 5, style: {textAlign: 'center', padding: '20px'}},
                                    'Боты не найдены'
                                )
                            ) :
                            bots.map(bot => {
                                const change = calculateChange(bot.startAdts, bot.currentAdts);
                                const changeClass = change === null ? '' :
                                    change > 0 ? 'positive-change' : 'negative-change';
                                const changeText = change === null ? 'N/A' : `${change > 0 ? '+' : ''}${change.toFixed(2)}%`;

                                return React.createElement('tr', {key: bot.botId},
                                    React.createElement('td', null, bot.botId),
                                    React.createElement('td', null, bot.symbol),
                                    React.createElement('td', {className: bot.startAdts === null ? 'null-value' : ''},
                                        formatNumber(bot.startAdts)
                                    ),
                                    React.createElement('td', null, formatNumber(bot.currentAdts)),
                                    // React.createElement('td', { className: changeClass }, changeText)
                                );
                            })
                    )
                ),
            React.createElement('div', {className: 'button-container'},
                React.createElement('button', {
                    type: 'button',
                    className: 'refresh-button',
                    onClick: fetchBots,
                    disabled: loadingBots
                }, loadingBots ? 'Обновление...' : 'Обновить список ботов')
            )
        );
    }

    // Рендерим приложение
    ReactDOM.render(React.createElement(App), document.getElementById('root'));
</script>
</body>
</html>
